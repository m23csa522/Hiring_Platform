{% extends 'base.html' %}
{% block content %}

<h3 class="mb-4">Interview Screen</h3>

<div class="row">

    <!-- OPTION 1: LIVE INTERVIEW RECORDING -->
    <div class="col-md-6">
        <div class="card p-3 shadow-sm">
            <h5>Live Interview</h5>

            <video id="preview" width="400" height="300" autoplay muted class="border"></video>

            <div class="mt-3">
                <button id="startBtn" class="btn btn-success">Start Recording</button>
                <button id="stopBtn" class="btn btn-danger" disabled>Stop Recording</button>
            </div>

            <p class="mt-2 text-muted">Recording is stored locally for now.</p>
        </div>
    </div>

    <!-- JS for LIVE RECORDING -->
    <script>
        let mediaRecorder;
        let chunks = [];
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");

        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => document.getElementById("preview").srcObject = stream);

        startBtn.onclick = () => {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();

                startBtn.disabled = true;
                stopBtn.disabled = false;

                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: "video/mp4" });
                    chunks = [];

                    // Download locally
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "interview_recording.mp4";
                    a.click();
                };
            });
        };

        stopBtn.onclick = () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
            startBtn.disabled = false;
            stopBtn.disabled = true;
        };
    </script>

    <!-- OPTION 2: UPLOAD RECORDED INTERVIEW VIDEO -->
    <div class="col-md-6">
        <div class="card p-3 shadow-sm">
            <h5>Upload Interview Video</h5>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="upload_video">

                <div class="mb-3">
                    <label>Select Video File (mp4/webm/mov):</label>
                    <input type="file" class="form-control" name="interview_video" accept="video/*" required>
                </div>

                <button class="btn btn-primary">Upload</button>
            </form>

            {% if msg %}
            <div class="alert alert-info mt-3">{{ msg }}</div>
            {% endif %}
        </div>
    </div>

</div>

{# --- Conversation view (speaker + text turns) --- #}
{% if conversation %}
<div class="card p-3 mt-4">
    <h5>Conversation</h5>
    <div>
        {% for turn in conversation %}
            <p><strong>{{ turn.speaker }}:</strong> {{ turn.text }}</p>
        {% endfor %}
    </div>
</div>
{% endif %}

{# --- Full transcript (raw text) --- #}
{% if transcript %}
<div class="card p-3 mt-3">
    <h5>Full Transcript</h5>
    <p>{{ transcript }}</p>
</div>
{% endif %}

{# --- Optional speaker timeline from diarization (if available) --- #}
{% if speakers %}
<div class="card p-3 mt-3">
    <h5>Speaker Timeline</h5>
    <ul>
        {% for s in speakers %}
            <li>{{ s }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{# --- Optional diarization error display --- #}
{% if diarization_error %}
<div class="alert alert-warning mt-3">
    Speaker diarization issue: {{ diarization_error }}
</div>
{% endif %}

{% endblock %}
